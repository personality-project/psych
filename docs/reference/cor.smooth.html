<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Smooth a non-positive definite correlation matrix to make it positive definite — cor.smooth • psych</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">psych</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Smooth a non-positive definite correlation matrix to make it positive definite</h1>
    </div>

    
    <p>Factor analysis requires positive definite correlation matrices.  Unfortunately, with pairwise deletion of missing data or if using <code><a href='tetrachor.html'>tetrachoric</a></code> or <code><a href='tetrachor.html'>polychoric</a></code> correlations, not all correlation matrices are positive definite.  cor.smooth does a eigenvector (principal components) smoothing.  Negative eigen values are replaced with 100  * eig.tol, the matrix is reproduced and forced to a correlation matrix using cov2cor.</p>
    

    <pre class="usage"><span class='fu'>cor.smooth</span>(<span class='no'>x</span>,<span class='kw'>eig.tol</span><span class='kw'>=</span><span class='fl'>10</span>^-<span class='fl'>12</span>)
<span class='fu'>cor.smoother</span>(<span class='no'>x</span>,<span class='kw'>cut</span><span class='kw'>=</span><span class='fl'>.01</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>A correlation matrix or a raw data matrix.</p></td>
    </tr>
    <tr>
      <th>eig.tol</th>
      <td><p>the minimum acceptable eigenvalue</p></td>
    </tr>
    <tr>
      <th>cut</th>
      <td><p>Report all abs(residuals)  &gt; cut</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The smoothing is done by eigen value decomposition.  eigen values &lt; eig.tol are changed to 100  * eig.tol.  The positive eigen values are rescaled to sum to the number of items.  The matrix is recomputed (eigen.vectors %*% diag(eigen.values) %*% t(eigen.vectors) and forced to a correlation matrix using cov2cor. (See Bock, Gibbons and Muraki, 1988 and Wothke, 1993).</p>
<p>This does not implement the Knol and ten Berge (1989) solution, nor do nearcor and posdefify in sfmsmisc, not does nearPD in Matrix. As Martin Maechler puts it in the posdedify function, "there are more sophisticated algorithms to solve this and related problems."</p>
<p>cor.smoother examines all of nvar minors of rank nvar-1 by systematically dropping one variable at a time and finding the eigen value decomposition.  It reports those variables, which, when dropped, produce a positive definite matrix.  It also reports the number of negative eigenvalues when each variable is dropped.  Finally, it compares the original correlation matrix to the smoothed correlation matrix and reports those items with absolute deviations great than cut.  These are all hints as to what might be wrong with a correlation matrix.</p>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>The smoothed matrix with a warning reporting that smoothing was necessary (if smoothing was in fact necessary).</p>
    
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>R. Darrell Bock, Robert Gibbons and Eiji Muraki (1988) Full-Information Item Factor Analysis. Applied Psychological Measurement, 12 (3), 261-280.</p>
<p>Werner Wothke (1993), Nonpositive definite matrices in structural modeling. In Kenneth A. Bollen and J. Scott Long (Editors),Testing structural equation models, Sage Publications, Newbury Park.</p>
<p>D.L. Knol and JMF ten Berge (1989) Least squares approximation of an improper correlation matrix by a proper one.  Psychometrika, 54, 53-61.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <p><code><a href='tetrachor.html'>tetrachoric</a></code>, <code><a href='tetrachor.html'>polychoric</a></code>, <code><a href='fa.html'>fa</a></code> and <code><a href='irt.fa.html'>irt.fa</a></code>, and the <code><a href='burt.html'>burt</a></code> data set.</p>
<p>See also nearcor and posdefify in the sfsmisc package and <code>nearPD</code> in the Matrix package.</p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='no'>bs</span> <span class='kw'>&lt;-</span> <span class='fu'>cor.smooth</span>(<span class='no'>burt</span>)  <span class='co'>#burt data set is not positive definite</span></div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='input'><span class='fu'>plot</span>(<span class='no'>burt</span>[<span class='fu'>lower.tri</span>(<span class='no'>burt</span>)],<span class='no'>bs</span>[<span class='fu'>lower.tri</span>(<span class='no'>bs</span>)],<span class='kw'>ylab</span><span class='kw'>=</span><span class='st'>"smoothed values"</span>,<span class='kw'>xlab</span><span class='kw'>=</span><span class='st'>"original values"</span>)</div><div class='input'><span class='fu'>abline</span>(<span class='fl'>0</span>,<span class='fl'>1</span>,<span class='kw'>lty</span><span class='kw'>=</span><span class='st'>"dashed"</span>)</div><img src='cor.smooth-5.png' alt='' width='540' height='400' /><div class='input'>
<span class='fu'>round</span>(<span class='no'>burt</span> - <span class='no'>bs</span>,<span class='fl'>3</span>)</div><div class='output co'>#&gt;            Sociality Sorrow Tenderness   Joy Wonder Elation Disgust  Anger
#&gt; Sociality      0.000  0.000      0.010 0.002  0.003   0.001   0.003  0.003
#&gt; Sorrow         0.000  0.000      0.016 0.004  0.005   0.002   0.006  0.006
#&gt; Tenderness     0.010  0.016      0.000 0.001 -0.001   0.002  -0.002 -0.003
#&gt; Joy            0.002  0.004      0.001 0.000  0.000   0.000   0.000  0.000
#&gt; Wonder         0.003  0.005     -0.001 0.000  0.000   0.000  -0.001  0.000
#&gt; Elation        0.001  0.002      0.002 0.000  0.000   0.000   0.000  0.001
#&gt; Disgust        0.003  0.006     -0.002 0.000 -0.001   0.000   0.000 -0.001
#&gt; Anger          0.003  0.006     -0.003 0.000  0.000   0.001  -0.001  0.000
#&gt; Sex            0.000 -0.001      0.004 0.001  0.001   0.000   0.001  0.002
#&gt; Fear           0.000  0.002      0.001 0.000  0.000   0.000   0.000  0.000
#&gt; Subjection     0.000  0.001      0.002 0.000  0.000   0.000   0.000  0.000
#&gt;               Sex  Fear Subjection
#&gt; Sociality   0.000 0.000      0.000
#&gt; Sorrow     -0.001 0.002      0.001
#&gt; Tenderness  0.004 0.001      0.002
#&gt; Joy         0.001 0.000      0.000
#&gt; Wonder      0.001 0.000      0.000
#&gt; Elation     0.000 0.000      0.000
#&gt; Disgust     0.001 0.000      0.000
#&gt; Anger       0.002 0.000      0.000
#&gt; Sex         0.000 0.000      0.000
#&gt; Fear        0.000 0.000      0.000
#&gt; Subjection  0.000 0.000      0.000</div><div class='input'><span class='fu'><a href='fa.html'>fa</a></span>(<span class='no'>burt</span>,<span class='fl'>2</span>) <span class='co'>#this throws a warning that the matrix yields an improper solution</span></div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='output co'>#&gt; <span class='message'>The estimated weights for the factor scores are probably incorrect.  Try a different factor extraction method.</span></div><div class='output co'>#&gt; <span class='warning'>Warning: An ultra-Heywood case was detected.  Examine the results carefully</span></div><div class='output co'>#&gt; Factor Analysis using method =  minres
#&gt; Call: fa(r = burt, nfactors = 2)
#&gt; Standardized loadings (pattern matrix) based upon correlation matrix
#&gt;              MR1   MR2   h2     u2 com
#&gt; Sociality   0.67  0.51 1.02 -0.021 1.9
#&gt; Sorrow      0.26  0.79 0.88  0.119 1.2
#&gt; Tenderness  0.03  0.88 0.79  0.205 1.0
#&gt; Joy         0.45  0.41 0.54  0.463 2.0
#&gt; Wonder      0.67  0.13 0.55  0.450 1.1
#&gt; Elation     0.61  0.16 0.48  0.523 1.1
#&gt; Disgust     0.39  0.26 0.31  0.690 1.7
#&gt; Anger       0.79 -0.15 0.54  0.462 1.1
#&gt; Sex         0.66 -0.08 0.40  0.605 1.0
#&gt; Fear       -0.19  0.59 0.29  0.715 1.2
#&gt; Subjection -0.43  0.60 0.31  0.689 1.8
#&gt; 
#&gt;                        MR1  MR2
#&gt; SS loadings           3.21 2.90
#&gt; Proportion Var        0.29 0.26
#&gt; Cumulative Var        0.29 0.55
#&gt; Proportion Explained  0.53 0.47
#&gt; Cumulative Proportion 0.53 1.00
#&gt; 
#&gt;  With factor correlations of 
#&gt;      MR1  MR2
#&gt; MR1 1.00 0.46
#&gt; MR2 0.46 1.00
#&gt; 
#&gt; Mean item complexity =  1.4
#&gt; Test of the hypothesis that 2 factors are sufficient.
#&gt; 
#&gt; The degrees of freedom for the null model are  55  and the objective function was  29.97
#&gt; The degrees of freedom for the model are 34  and the objective function was  23.27 
#&gt; 
#&gt; The root mean square of the residuals (RMSR) is  0.07 
#&gt; The df corrected root mean square of the residuals is  0.1 
#&gt; 
#&gt; Fit based upon off diagonal values = 0.97</div><div class='input'><span class='co'>#Smoothing first throws a warning that the matrix was improper, </span>
<span class='co'>#but produces a better solution </span>
<span class='fu'><a href='fa.html'>fa</a></span>(<span class='fu'>cor.smooth</span>(<span class='no'>burt</span>),<span class='fl'>2</span>)</div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='output co'>#&gt; <span class='message'>The estimated weights for the factor scores are probably incorrect.  Try a different factor extraction method.</span></div><div class='output co'>#&gt; <span class='warning'>Warning: An ultra-Heywood case was detected.  Examine the results carefully</span></div><div class='output co'>#&gt; Factor Analysis using method =  minres
#&gt; Call: fa(r = cor.smooth(burt), nfactors = 2)
#&gt; Standardized loadings (pattern matrix) based upon correlation matrix
#&gt;              MR1   MR2   h2     u2 com
#&gt; Sociality   0.68  0.50 1.02 -0.019 1.8
#&gt; Sorrow      0.28  0.77 0.87  0.130 1.3
#&gt; Tenderness  0.05  0.86 0.78  0.223 1.0
#&gt; Joy         0.46  0.40 0.54  0.462 2.0
#&gt; Wonder      0.68  0.12 0.55  0.451 1.1
#&gt; Elation     0.61  0.15 0.48  0.523 1.1
#&gt; Disgust     0.40  0.25 0.31  0.690 1.7
#&gt; Anger       0.79 -0.16 0.53  0.465 1.1
#&gt; Sex         0.67 -0.09 0.40  0.604 1.0
#&gt; Fear       -0.19  0.60 0.29  0.711 1.2
#&gt; Subjection -0.42  0.61 0.31  0.685 1.8
#&gt; 
#&gt;                        MR1  MR2
#&gt; SS loadings           3.25 2.82
#&gt; Proportion Var        0.30 0.26
#&gt; Cumulative Var        0.30 0.55
#&gt; Proportion Explained  0.54 0.46
#&gt; Cumulative Proportion 0.54 1.00
#&gt; 
#&gt;  With factor correlations of 
#&gt;      MR1  MR2
#&gt; MR1 1.00 0.45
#&gt; MR2 0.45 1.00
#&gt; 
#&gt; Mean item complexity =  1.4
#&gt; Test of the hypothesis that 2 factors are sufficient.
#&gt; 
#&gt; The degrees of freedom for the null model are  55  and the objective function was  29.97
#&gt; The degrees of freedom for the model are 34  and the objective function was  23.22 
#&gt; 
#&gt; The root mean square of the residuals (RMSR) is  0.07 
#&gt; The df corrected root mean square of the residuals is  0.09 
#&gt; 
#&gt; Fit based upon off diagonal values = 0.97</div><div class='input'>
<span class='co'>#this next example is a correlation matrix from DeLeuw used as an example </span>
<span class='co'>#in Knol and ten Berge.  </span>
<span class='co'>#the example is also used in the nearcor documentation</span>
 <span class='fu'>cat</span>(<span class='st'>"pr is the example matrix used in Knol DL, ten Berge (1989)\n"</span>)</div><div class='output co'>#&gt; pr is the example matrix used in Knol DL, ten Berge (1989)</div><div class='input'> <span class='no'>pr</span> <span class='kw'>&lt;-</span> <span class='fu'>matrix</span>(<span class='fu'>c</span>(<span class='fl'>1</span>,     <span class='fl'>0.477</span>, <span class='fl'>0.644</span>, <span class='fl'>0.478</span>, <span class='fl'>0.651</span>, <span class='fl'>0.826</span>,
                <span class='fl'>0.477</span>, <span class='fl'>1</span>,     <span class='fl'>0.516</span>, <span class='fl'>0.233</span>, <span class='fl'>0.682</span>, <span class='fl'>0.75</span>,
                <span class='fl'>0.644</span>, <span class='fl'>0.516</span>, <span class='fl'>1</span>,     <span class='fl'>0.599</span>, <span class='fl'>0.581</span>, <span class='fl'>0.742</span>,
                <span class='fl'>0.478</span>, <span class='fl'>0.233</span>, <span class='fl'>0.599</span>, <span class='fl'>1</span>,     <span class='fl'>0.741</span>, <span class='fl'>0.8</span>,
                <span class='fl'>0.651</span>, <span class='fl'>0.682</span>, <span class='fl'>0.581</span>, <span class='fl'>0.741</span>, <span class='fl'>1</span>,     <span class='fl'>0.798</span>,
                <span class='fl'>0.826</span>, <span class='fl'>0.75</span>,  <span class='fl'>0.742</span>, <span class='fl'>0.8</span>,   <span class='fl'>0.798</span>, <span class='fl'>1</span>),
              <span class='kw'>nrow</span> <span class='kw'>=</span> <span class='fl'>6</span>, <span class='kw'>ncol</span> <span class='kw'>=</span> <span class='fl'>6</span>)

<span class='no'>sm</span> <span class='kw'>&lt;-</span> <span class='fu'>cor.smooth</span>(<span class='no'>pr</span>)</div><div class='output co'>#&gt; <span class='warning'>Warning: Matrix was not positive definite, smoothing was done</span></div><div class='input'><span class='no'>resid</span> <span class='kw'>&lt;-</span> <span class='no'>pr</span> - <span class='no'>sm</span>
<span class='co'># several goodness of fit tests</span>
<span class='co'># from Knol and ten Berge</span>
<span class='fu'><a href='tr.html'>tr</a></span>(<span class='no'>resid</span> <span class='kw'>%*%</span> <span class='fu'>t</span>(<span class='no'>resid</span>)) /<span class='fl'>2</span></div><div class='output co'>#&gt; [1] 0.003520413</div><div class='input'>
<span class='co'># from nearPD</span>
<span class='fu'>sum</span>(<span class='no'>resid</span>^<span class='fl'>2</span>)/<span class='fl'>2</span></div><div class='output co'>#&gt; [1] 0.003520413</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#details">Details</a></li>

      <li><a href="#value">Value</a></li>

      <li><a href="#references">References</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

    <h2>Author</h2>
    William Revelle
  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by William Revelle.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
